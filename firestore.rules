
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
  
    // Deny all reads and writes by default
    match /{document=**} {
      allow read, write: if false;
    }

    // USERS
    // - Allow anyone authenticated to read user profiles (for directory, etc.)
    // - Allow users to create their own profile document (on signup)
    // - Allow users to update their own profile (name, bio)
    match /users/{userId} {
      allow read: if request.auth != null;
      allow create: if request.auth.uid == userId;
      allow update: if request.auth.uid == userId && request.resource.data.keys().hasAll(['name', 'bio']);
    }

    // STORIES
    // - Allow any authenticated user to read stories
    // - Allow authenticated users to create new stories
    match /stories/{storyId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null;
      // Note: Liking/commenting would need additional rules
    }
    
    // MESSAGES
    // - Allow reading messages where the user is a participant
    // - Allow creating messages with the user as a participant
    match /messages/{messageId} {
        allow read: if request.auth != null;  // Allow listing for queries
        allow create: if request.auth != null 
            && request.resource.data.participants.hasAny([request.auth.uid])
            && request.resource.data.from == request.auth.uid;
    }

    // EVENTS
    // - Allow any authenticated user to read events
    match /events/{eventId} {
        allow read: if request.auth != null;
    }

    // EVENT RSVPS
    // - Users can only create/delete RSVPs for themselves
    match /event_rsvps/{rsvpId} {
        allow read: if request.auth != null && request.auth.uid == resource.data.userId;
        allow create: if request.auth != null && request.auth.uid == request.resource.data.userId;
        allow delete: if request.auth != null && request.auth.uid == resource.data.userId;
    }
    
    // MENTORSHIPS
    // - Allow authenticated users to read mentorships (filtered by client)
    // - Allow authenticated users to create requests
    match /mentorships/{mentorshipId} {
      allow read: if request.auth != null;  // Enable listing for queries
      allow create: if request.auth != null;
      allow update: if request.auth != null && 
        ((request.auth.uid == resource.data.mentorId) || 
         (request.auth.uid == resource.data.userId));
    }

      // MENTORING SESSIONS
      // - Allow mentors to read all their sessions and mentees to read their specific sessions
      match /mentoring_sessions/{sessionId} {
        allow read: if request.auth != null;  // Allow listing for queries
        allow create: if request.auth != null;
      }

    // MENTOR RESOURCES
    // - Allow mentors to read their resources
    match /mentor_resources/{resourceId} {
      allow read: if request.auth != null && request.auth.uid == resource.data.mentorId;
      allow create: if request.auth != null && request.auth.uid == request.resource.data.mentorId;
    }

    // MENTOR RATINGS
    // - Allow mentors to read their ratings
    match /mentor_ratings/{ratingId} {
      allow read: if request.auth != null && request.auth.uid == resource.data.mentorId;
      allow create: if request.auth != null && request.auth.uid == request.resource.data.mentorId;
    }

    // PROMPTS
    // - Allow any authenticated user to read daily prompts
    match /prompts/{promptId} {
      allow read: if request.auth != null;
    }

    // MOOD LOGS
    // - Users can only create mood logs for themselves in their own subcollection.
    match /mood_logs/{userId}/logs/{logId} {
        allow create: if request.auth != null && request.auth.uid == userId;
        allow read: if request.auth != null && request.auth.uid == userId;
    }

    // BROADCASTS
    // - Allow authenticated users to read broadcasts
    match /broadcasts/{broadcastId} {
      allow read: if request.auth != null;
      // Writes are handled by an admin-only Cloud Function
    }

    // FEEDBACK
    // - Allow authenticated users to create feedback
    match /feedback/{feedbackId} {
        allow create: if request.auth != null;
        // Reads are handled by an admin-only Cloud Function/Admin SDK
    }

    // SERVICES
    // - Allow authenticated users to read approved services
    match /services/{serviceId} {
        allow read: if request.auth != null && resource.data.status == 'Approved';
        // Creating and managing services would likely be done via Cloud Functions
    }

    // NOTIFICATIONS
    // - Users can only read notifications intended for them
    match /notifications/{userId}/user_notifications/{notificationId} {
      allow read: if request.auth != null && request.auth.uid == userId;
    }
  }
}
